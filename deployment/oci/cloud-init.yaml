#cloud-config

packages:
  - python3
  - python3-pip
  - python3-venv
  - docker.io
  - docker-compose
  - git
  - nginx
  - certbot
  - python3-certbot-nginx

write_files:
  - path: /opt/rune/vault_token
    content: ${vault_token}
    permissions: '0600'
    owner: root:root

  - path: /opt/rune/docker-compose.yml
    content: |
      version: '3.8'
      services:
        vault:
          image: ghcr.io/cryptolabinc/rune-vault:latest
          container_name: rune-vault
          restart: unless-stopped
          ports:
            - "50080:50080"
          volumes:
            - ./keys:/vault/keys
            - ./vault_token:/vault/token:ro
          environment:
            - VAULT_TOKEN_FILE=/vault/token
            - LOG_LEVEL=INFO
          healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:50080/health"]
            interval: 30s
            timeout: 10s
            retries: 3

  - path: /etc/nginx/sites-available/vault
    content: |
      server {
          listen 443 ssl http2;
          server_name vault-${team_name}.oci.envector.io;

          ssl_certificate /etc/letsencrypt/live/vault-${team_name}.oci.envector.io/fullchain.pem;
          ssl_certificate_key /etc/letsencrypt/live/vault-${team_name}.oci.envector.io/privkey.pem;

          location / {
              proxy_pass http://localhost:50080;
              proxy_http_version 1.1;
              proxy_set_header Upgrade $http_upgrade;
              proxy_set_header Connection 'upgrade';
              proxy_set_header Host $host;
              proxy_cache_bypass $http_upgrade;
          }

          location /health {
              proxy_pass http://localhost:50080/health;
              access_log off;
          }
      }

      server {
          listen 80;
          server_name vault-${team_name}.oci.envector.io;
          return 301 https://$server_name$request_uri;
      }

runcmd:
  # Add user to docker group
  - usermod -aG docker ubuntu

  # Setup Rune-Vault
  - mkdir -p /opt/rune/keys
  - cd /opt/rune
  - docker-compose pull
  - docker-compose up -d

  # Wait for vault to be ready
  - sleep 10

  # Setup nginx reverse proxy
  - ln -s /etc/nginx/sites-available/vault /etc/nginx/sites-enabled/
  - rm /etc/nginx/sites-enabled/default || true

  # Get SSL certificate (will fail first time, DNS needs to be configured)
  - |
    certbot --nginx -d vault-${team_name}.oci.envector.io \
      --non-interactive --agree-tos \
      --email admin@envector.io \
      || echo "SSL cert failed - configure DNS first"

  # Restart nginx
  - systemctl restart nginx

  # Enable services
  - systemctl enable docker
  - systemctl enable nginx

final_message: |
  Rune-Vault installation complete!
  
  Vault URL: https://vault-${team_name}.oci.envector.io
  Vault Token: ${vault_token}
  
  Note: Configure DNS to point vault-${team_name}.oci.envector.io to this instance's IP
  Then run: certbot --nginx -d vault-${team_name}.oci.envector.io
